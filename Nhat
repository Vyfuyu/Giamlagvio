--[[
    Script: AIO Optimization Menu - COMPACT V3
    Tác giả: Gemini
    Cập nhật: Thêm thanh cuộn, thu nhỏ giao diện, thêm Noclip, Click TP, Sprint.
]]

--// SERVICES //--
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")
local MaterialService = game:GetService("MaterialService")

--// PLAYER & CHARACTER //--
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

--// UI CONFIG //--
local THEME = {
    BackgroundColor = Color3.fromRGB(28, 28, 35),
    AccentColor = Color3.fromRGB(0, 150, 255),
    TextColor = Color3.fromRGB(255, 255, 255),
    ToggledColor = Color3.fromRGB(100, 255, 120),
    Font = Enum.Font.GothamSemibold
}

--// MAIN GUI //--
local AioGui = game.Players.LocalPlayer.PlayerGui:FindFirstChild("AioOptimizationGui") or Instance.new("ScreenGui")
AioGui.Name = "AioOptimizationGui"
AioGui.ZIndexBehavior = Enum.ZIndexBehavior.Global
AioGui.ResetOnSpawn = false
AioGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- Xóa UI cũ nếu có để làm mới
for _,v in ipairs(AioGui:GetChildren()) do v:Destroy() end

--// MENU TOGGLE BUTTON //--
local OpenButton = Instance.new("TextButton")
OpenButton.Name = "OpenButton"; OpenButton.Size = UDim2.new(0, 100, 0, 30)
OpenButton.Position = UDim2.new(0, 15, 0, 15); OpenButton.Text = "Menu"
OpenButton.TextColor3 = THEME.TextColor; OpenButton.BackgroundColor3 = THEME.AccentColor
OpenButton.Font = THEME.Font; OpenButton.TextSize = 16; OpenButton.Parent = AioGui
local UICorner_Open = Instance.new("UICorner", OpenButton); UICorner_Open.CornerRadius = UDim.new(0, 8)

--// MAIN FRAME //--
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"; MainFrame.Size = UDim2.new(0, 220, 0, 380) -- Thu nhỏ kích thước
MainFrame.Position = UDim2.new(0, -230, 0, 55); MainFrame.BackgroundColor3 = THEME.BackgroundColor
MainFrame.BorderSizePixel = 0; MainFrame.Active = true; MainFrame.Draggable = true
MainFrame.Parent = AioGui
local UICorner_Main = Instance.new("UICorner", MainFrame); UICorner_Main.CornerRadius = UDim.new(0, 10)
local UIStroke_Main = Instance.new("UIStroke", MainFrame); UIStroke_Main.Color = THEME.AccentColor
UIStroke_Main.Thickness = 1.5

--// FRAME TITLE //--
local TitleLabel = Instance.new("TextLabel")
TitleLabel.Name = "Title"; TitleLabel.Size = UDim2.new(1, 0, 0, 40)
TitleLabel.Text = "Compact V3"; TitleLabel.TextColor3 = THEME.AccentColor
TitleLabel.BackgroundTransparency = 1; TitleLabel.Font = THEME.Font
TitleLabel.TextSize = 22; TitleLabel.Parent = MainFrame

--// SCROLLING FRAME //--
local ScrollingFrame = Instance.new("ScrollingFrame")
ScrollingFrame.Size = UDim2.new(1, 0, 1, -40); ScrollingFrame.Position = UDim2.new(0, 0, 0, 40)
ScrollingFrame.BackgroundTransparency = 1; ScrollingFrame.BorderSizePixel = 0
ScrollingFrame.ScrollBarImageColor3 = THEME.AccentColor; ScrollingFrame.ScrollBarThickness = 6
ScrollingFrame.Parent = MainFrame

local UIListLayout = Instance.new("UIListLayout", ScrollingFrame)
UIListLayout.Padding = UDim.new(0, 8)
UIListLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
UIListLayout.SortOrder = Enum.SortOrder.LayoutOrder

-- Tự động cập nhật kích thước cuộn
UIListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ScrollingFrame.CanvasSize = UDim2.new(0, 0, 0, UIListLayout.AbsoluteContentSize.Y)
end)

--// MENU TOGGLE LOGIC //--
local menuVisible = false
local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quint, Enum.EasingDirection.Out)
OpenButton.MouseButton1Click:Connect(function()
    menuVisible = not menuVisible
    local targetPosition = menuVisible and UDim2.new(0, 15, 0, 55) or UDim2.new(0, -230, 0, 55)
    TweenService:Create(MainFrame, tweenInfo, { Position = targetPosition }):Play()
    OpenButton.Text = menuVisible and "Close" or "Menu"
end)

--// HELPER FUNCTIONS (parent to ScrollingFrame now) //--
local function createButton(text, callback)
    local btn = Instance.new("TextButton")
    btn.Name = text; btn.Size = UDim2.new(1, -15, 0, 35)
    btn.Text = text; btn.TextColor3 = THEME.TextColor
    btn.BackgroundColor3 = Color3.fromRGB(50, 52, 60)
    btn.Font = THEME.Font; btn.TextSize = 16
    btn.Parent = ScrollingFrame -- Thay đổi parent
    local UICorner_Btn = Instance.new("UICorner", btn); UICorner_Btn.CornerRadius = UDim.new(0, 6)
    if callback then btn.MouseButton1Click:Connect(callback) end
    return btn
end

local function createToggleButton(text, callbackOn, callbackOff)
    local btn = createButton(text, nil); local toggled = false
    local function updateVisuals()
        btn.BackgroundColor3 = toggled and THEME.ToggledColor or Color3.fromRGB(50, 52, 60)
        btn.TextColor3 = toggled and Color3.fromRGB(0,0,0) or THEME.TextColor
    end
    btn.MouseButton1Click:Connect(function()
        toggled = not toggled; updateVisuals()
        if toggled and callbackOn then callbackOn()
        elseif not toggled and callbackOff then callbackOff() end
    end)
    return btn, function() return toggled end
end

local function createSection(text)
    local label = Instance.new("TextLabel", ScrollingFrame) -- Thay đổi parent
    label.Size = UDim2.new(1, -15, 0, 20)
    label.Text = `--- {text} ---`; label.TextColor3 = THEME.TextColor
    label.BackgroundTransparency = 1; label.Font = Enum.Font.Gotham
    label.TextSize = 14
    return label
end


--// ===== FEATURES ===== //--

createSection("Di Chuyển & Tiện Ích")

local noclipConnection; local nocliping = false
createToggleButton("Noclip (Đi xuyên tường)", function()
    nocliping = true; noclipConnection = RunService.Stepped:Connect(function()
        local char = LocalPlayer.Character
        if char and nocliping then
            for _, part in ipairs(char:GetDescendants()) do
                if part:IsA("BasePart") then part.CanCollide = false end
            end
        end
    end)
end, function()
    nocliping = false; if noclipConnection then noclipConnection:Disconnect() end
end)

local clickTpConnection
createToggleButton("Click TP (Ctrl + Click)", function()
    clickTpConnection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) and input.UserInputType == Enum.UserInputType.MouseButton1 then
            local char = LocalPlayer.Character
            if char and char:FindFirstChild("HumanoidRootPart") then
                char.HumanoidRootPart.CFrame = CFrame.new(Mouse.Hit.Position)
            end
        end
    end)
end, function()
    if clickTpConnection then clickTpConnection:Disconnect() end
end)

local originalSpeed
createToggleButton("Sprint (Chạy Nhanh)", function()
    local human = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    if human then originalSpeed = human.WalkSpeed; human.WalkSpeed = 75 end
end, function()
    local human = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    if human and originalSpeed then human.WalkSpeed = originalSpeed end
end)

createSection("Đồ Họa & Render")
createButton("Ép Xung Đồ Họa (Cực Mạnh)", function()
    settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
    Lighting.Technology = Enum.Technology.Compatibility
    Lighting.GlobalShadows = false
    MaterialService:SetGlobalMaterialOverride(Enum.Material.Plastic)
end)

local originalFogEnd = Lighting.FogEnd
createToggleButton("Sương Mù Chống Lag", function() Lighting.FogEnd = 120 end, function() Lighting.FogEnd = originalFogEnd end)

createButton("Xóa Màu Sắc (Grayscale)", function()
    for _, obj in ipairs(workspace:GetDescendants()) do
        if obj:IsA("BasePart") and not obj:IsDescendantOf(LocalPlayer.Character) then
            obj.Color = Color3.fromRGB(128, 128, 128)
        end
    end
end)


createSection("Dọn Dẹp & Hủy Diệt")
createToggleButton("Ẩn Người Chơi Khác", function()
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChildOfClass("Humanoid") then
            p.Character.Humanoid.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.None
        end
    end
end, function()
    for _, p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChildOfClass("Humanoid") then
            p.Character.Humanoid.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.Viewer
        end
    end
end)

createButton("Xóa Hiệu Ứng + Ánh Sáng", function()
    for _, v in ipairs(workspace:GetDescendants()) do
        if v:IsA("ParticleEmitter") or v:IsA("Trail") or v:IsA("Beam") or v:IsA("Smoke") or v:IsA("Fire") or v:IsA("Light") then
            v:Destroy()
        end
    end
end)

createButton("Xóa Toàn Bộ Map (100%)", function()
    local char = LocalPlayer.Character
    for _, v in ipairs(workspace:GetChildren()) do if v ~= char then v:Destroy() end end
    local base = Instance.new("Part", workspace)
    base.Size = Vector3.new(2048, 1, 2048)
    base.Position = char.HumanoidRootPart.Position - Vector3.new(0, 20, 0)
    base.Anchored = true; base.Color = Color3.fromRGB(50,50,50)
end)
